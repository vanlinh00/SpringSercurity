<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Location Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>üìç WebSocket Location Test</h2>

<label>User ID: <input id="userId" placeholder="user1" /></label><br>
<label>Group ID: <input id="groupId" placeholder="group1" /></label><br><br>

<button onclick="connect()">üîå K·∫øt n·ªëi</button>
<button onclick="sendLocation()">üì§ G·ª≠i v·ªã tr√≠</button>
<p id="status">‚ö™ Ch∆∞a k·∫øt n·ªëi</p>

<ul id="messages"></ul>

<script>
    let stompClient = null;
    let currentUserId = "";
    let currentGroupId = "";

    function connect() {
        currentUserId = document.getElementById("userId").value.trim();
        currentGroupId = document.getElementById("groupId").value.trim();

        if (!currentUserId || !currentGroupId) {
            alert("Vui l√≤ng nh·∫≠p c·∫£ User ID v√† Group ID.");
            return;
        }

        const socket = new SockJS("http://localhost:8080/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            document.getElementById("status").innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi: " + frame;

            // Subcribe ƒë√∫ng group ID t·ª´ ng∆∞·ªùi d√πng nh·∫≠p
            stompClient.subscribe(`/topic/location/group-${currentGroupId}`, function (message) {
                const msg = JSON.parse(message.body);
                const li = document.createElement("li");
                li.innerText = `üìç ${msg.userId}: (${msg.latitude}, ${msg.longitude})`;
                document.getElementById("messages").appendChild(li);
            });
        });
    }

    function sendLocation() {
        if (!stompClient || !stompClient.connected) {
            alert("B·∫°n c·∫ßn k·∫øt n·ªëi tr∆∞·ªõc.");
            return;
        }

        const payload = {
            userId: currentUserId,
            groupId: currentGroupId,
            latitude: 10.762622 + Math.random() / 100,   // gi·∫£ l·∫≠p v·ªã tr√≠ ƒë·ªông
            longitude: 106.660172 + Math.random() / 100,
            timestamp: Date.now()
        };

        stompClient.send("/app/location/update", {}, JSON.stringify(payload));
    }
</script>
</body>
</html>
